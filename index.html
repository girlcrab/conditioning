<!DOCTYPE html>
<html>
  <head>
    <title>Sissynator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/blueimp-gallery/2.29.0/css/blueimp-gallery.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-gallery/2.29.0/js/blueimp-gallery.min.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.7/howler.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

    <style type="text/css">
      body {
        color: #f8adff;
        background-color: #000000;
        font-size: 16px;
      }
      h1 {
        font-weight: bold;
      }
      ol,
      ul {
        display: inline-block;
      }
      #metronome-tick {
        display: none;
      }
      #settings {
        margin-top: 2em;
        padding-bottom: 2em;
      }
      .btn-primary,
      .btn-primary:focus,
      .btn-primary:active {
        background-color: #f15aff !important;
        border-color: #ffffff !important;
      }
      .btn-primary:hover {
        background-color: #d200e6 !important;
        border-color: #750080 !important;
      }
      a,
      a:hover {
        color: #d200e6 !important;
      }
      #blueimp-gallery.blueimp-gallery > .play-pause {
        width: 40px;
        height: 40px;
        background-size: 80px 40px;
      }
      #blueimp-gallery.blueimp-gallery-playing > .play-pause {
        background-position: -40px 0;
      }
      .policy {
        font-size: 75%;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid text-center">
      <h1>Sissynator</h1>
      <h4>aka. Sissy Academy Conditioning Helper</h4>
      <p>This tool will help you with your conditioning.</p>
      <ol class="text-left">
        <li>Choose a folder with images from your local machine.</li>
        <li>Set the beats per minute and after how many beats the next image should appear.</li>
        <li>Press start and fully concentrate on your mantra!</li>
      </ol>
      <p><small><b>Hint:</b> You can use the space bar to pause.</small></p>
      <p><small>You need to upload a folder with images from your local machine.</small></p>
      <p class="policy"><a href="privacy.html">Privacy Policy</a> & <a href="https://github.com/sandyslut/conditioning">Source Code</a></p>

      <div class="row">
        <div id="settings" class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4">
          <form class="form-horizontal" autocomplete="off">
            <div id="beats-group" class="form-group has-feedback">
              <label class="control-label col-xs-4" for="beats-input">BPM:</label>
              <div class="col-xs-8">
                <input class="form-control" id="beats-input" type="number">
                <small id="beats-help" class="form-text text-muted">
                  Set to 0 to just show the gallery.
                </small>
              </div>
            </div>
            <div id="next-group" class="form-group has-feedback">
              <label class="control-label col-xs-4" for="next-input">Next image:</label>
              <div class="col-xs-8">
                <input class="form-control" id="next-input" type="number">
                <small id="next-help" class="form-text text-muted">
                  Set to 0 to disable the automatic slideshow.
                </small>
              </div>
            </div>
            <div id="limit-group" class="form-group has-feedback">
              <label class="control-label col-xs-4" for="limit-input">Limit:</label>
              <div class="col-xs-8">
                <input class="form-control" id="limit-input" type="number">
                <small id="limit-help" class="form-text text-muted">
                  Set to 0 to use all files.
                </small>
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-xs-4" for="folderInput">Choose Folder:</label>
              <div class="col-xs-8">
                <input type="file" id="folderInput" webkitdirectory multiple>
                <small class="form-text text-muted">Choose a folder with images from your local machine.</small>
              </div>
            </div>
          </form>
          <button id="start-button" class="btn btn-primary">Start</button>
          <br><br>
          <small id="start-help" class="form-text text-muted"></small>
        </div>
      </div>
    </div>

    <div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls">
      <div class="slides"></div>
      <a class="prev">‹</a>
      <a class="next">›</a>
      <a class="close">×</a>
      <a id="play-pause" class="play-pause"></a>
      <ol class="indicator"></ol>
    </div>

    <script type="text/javascript">
      let uploadedImageUrls = []; // Store uploaded image URLs

      document.getElementById('folderInput').addEventListener('change', function (event) {
        const files = Array.from(event.target.files);
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        uploadedImageUrls = imageFiles.map(file => URL.createObjectURL(file));

        // Display a message indicating the number of images loaded
        document.getElementById('start-help').innerText = `${uploadedImageUrls.length} images loaded. Click "Start" to begin.`;
      });

      document.getElementById('start-button').addEventListener('click', function () {
        if (!uploadedImageUrls || uploadedImageUrls.length === 0) {
          alert('Please upload a folder with images before starting.');
          return;
        }

        let imageUrls = [...uploadedImageUrls]; // Clone the array

        // Shuffle images if the shuffle checkbox is checked
        if (document.getElementById('shuffle-checkbox')?.checked) {
          shuffle(imageUrls);
        }

        // Limit the number of images if a limit is set
        const limit = parseInt(document.getElementById('limit-input').value, 10);
        if (limit > 0) {
          imageUrls = imageUrls.slice(0, limit);
        }

        // Initialize the blueimp gallery with the image URLs
        blueimp.Gallery(imageUrls, {
          container: '#blueimp-gallery',
          carousel: true,
        });

        // Start the metronome if BPM is set
        const bpm = parseInt(document.getElementById('beats-input').value, 10);
        if (bpm > 0) {
          startMetronome(bpm, imageUrls.length);
        }
      });

      function startMetronome(bpm, totalImages) {
        const interval = 60000 / bpm; // Calculate interval in milliseconds
        let tickCount = 0;

        function tick() {
          if (tickCount >= totalImages) {
            clearInterval(metronome);
            return;
          }
          document.querySelector('.blueimp-gallery .next').click(); // Move to the next image
          tickCount++;
        }

        const metronome = setInterval(tick, interval);
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }
    </script>
  </body>
</html>
